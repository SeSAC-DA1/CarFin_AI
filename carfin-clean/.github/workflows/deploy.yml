name: ğŸš€ Deploy to Vercel

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‘ì—…
  build-and-test:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: carfin-clean

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'carfin-clean/package-lock.json'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ” Run TypeScript check
      run: npx tsc --noEmit

    - name: ğŸ—ï¸ Build application
      run: npm run build
      env:
        # ë¹Œë“œì— í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ë“¤
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        NODE_ENV: production
        NEXT_TELEMETRY_DISABLED: 1

  # Preview ë°°í¬ (PRìš©)
  deploy-preview:
    name: ğŸ” Deploy Preview
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: carfin-clean

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'carfin-clean/package-lock.json'

    - name: ğŸ“¦ Install Vercel CLI
      run: npm install --global vercel@latest

    - name: ğŸ”§ Pull Vercel Environment Information
      run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

    - name: ğŸ—ï¸ Build Project Artifacts
      run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

    - name: ğŸš€ Deploy Project Artifacts to Vercel
      run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}

  # Production ë°°í¬ (main ë¸Œëœì¹˜ìš©)
  deploy-production:
    name: ğŸŒŸ Deploy Production
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    defaults:
      run:
        working-directory: carfin-clean

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'carfin-clean/package-lock.json'

    - name: ğŸ“¦ Install Vercel CLI
      run: npm install --global vercel@latest

    - name: ğŸ”§ Pull Vercel Environment Information
      run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

    - name: ğŸ—ï¸ Build Project Artifacts
      run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

    - name: ğŸš€ Deploy Project Artifacts to Vercel
      run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

    - name: ğŸ¯ Update Deployment Status
      run: |
        echo "ğŸ‰ Production deployment completed!"
        echo "ğŸŒ URL: https://carfin-ai.vercel.app"

  # ë°°í¬ í›„ í—¬ìŠ¤ì²´í¬
  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸ” Wait for deployment
      run: sleep 30

    - name: ğŸ¥ Check main page
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" https://carfin-ai.vercel.app)
        if [ $response -eq 200 ]; then
          echo "âœ… Main page is healthy (HTTP $response)"
        else
          echo "âŒ Main page failed (HTTP $response)"
          exit 1
        fi

    - name: ğŸ” Check database status API
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" https://carfin-ai.vercel.app/api/database/status)
        if [ $response -eq 200 ]; then
          echo "âœ… Database API is healthy (HTTP $response)"
        else
          echo "âŒ Database API failed (HTTP $response)"
          exit 1
        fi

    - name: ğŸš— Check vehicle analysis API
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" https://carfin-ai.vercel.app/api/vehicle/analysis/319258)
        if [ $response -eq 200 ]; then
          echo "âœ… Vehicle Analysis API is healthy (HTTP $response)"
        else
          echo "âŒ Vehicle Analysis API failed (HTTP $response)"
          exit 1
        fi

  # ë°°í¬ ì„±ê³µ ì•Œë¦¼
  notification:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-production, health-check]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸ‰ Success Notification
      if: needs.deploy-production.result == 'success' && needs.health-check.result == 'success'
      run: |
        echo "ğŸš€ CarFin AI ë°°í¬ ì„±ê³µ!"
        echo "ğŸŒ URL: https://carfin-ai.vercel.app"
        echo "ğŸ“Š Database: 170K+ ë§¤ë¬¼ ì—°ë™"
        echo "ğŸ¤– AI Analysis: ì •ìƒ ì‘ë™"
        echo "â±ï¸ ë°°í¬ ì‹œê°„: $(date)"

    - name: âŒ Failure Notification
      if: needs.deploy-production.result == 'failure' || needs.health-check.result == 'failure'
      run: |
        echo "âŒ CarFin AI ë°°í¬ ì‹¤íŒ¨!"
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
        exit 1