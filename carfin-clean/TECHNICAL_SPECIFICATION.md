# CarFin AI - ê¸°ìˆ  ëª…ì„¸ì„œ

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ì „ì²´ êµ¬ì¡°ë„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend (Next.js 15)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   React Components  â”‚        API Routes                 â”‚
â”‚   - ChatRoom        â”‚        - /api/chat                â”‚
â”‚   - PersonaCards    â”‚        - /api/database/*          â”‚
â”‚   - VehicleCards    â”‚        - /api/test/*              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              A2A Collaboration Engine                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¯ ìƒë‹´ ì´ê´„     ğŸ” ë‹ˆì¦ˆ ë¶„ì„     ğŸ“Š ì°¨ëŸ‰ ì¶”ì²œ         â”‚
â”‚  - ì§ˆë¬¸ íŒŒì‹±      - í˜ë¥´ì†Œë‚˜ ê°ì§€   - ë§¤ë¬¼ ê²€ìƒ‰         â”‚
â”‚  - íë¦„ ê´€ë¦¬      - ë¼ì´í”„ìŠ¤íƒ€ì¼    - TCO ê³„ì‚°          â”‚
â”‚  - ì‘ë‹µ ì¡°ìœ¨      - ë‹ˆì¦ˆ ë°œêµ´       - ë­í‚¹ ìƒì„±         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Data Layer & Cache                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PostgreSQL (170K+ ë§¤ë¬¼)  â”‚  Vercel Cache (í•˜ì´ë¸Œë¦¬ë“œ)   â”‚
â”‚  - vehicle_listings       â”‚  - Memory Cache            â”‚
â”‚  - real-time prices       â”‚  - File Cache              â”‚
â”‚  - 17 data fields         â”‚  - KV Store                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš™ï¸ í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ

### Frontend Technologies
```typescript
// Package.json ì£¼ìš” ì˜ì¡´ì„±
{
  "next": "15.5.4",           // ìµœì‹  App Router
  "react": "19.1.0",          // React 19 ìµœì‹  ê¸°ëŠ¥
  "typescript": "^5",         // ì™„ì „í•œ íƒ€ì… ì•ˆì „ì„±
  "tailwindcss": "^3.4.1",   // ìœ í‹¸ë¦¬í‹° ìš°ì„  CSS
  "lucide-react": "^0.344.0" // ì•„ì´ì½˜ ì‹œìŠ¤í…œ
}
```

### Backend & AI
```typescript
// AI Integration
{
  "@google/generative-ai": "^0.21.0", // Gemini 2.5 Flash
  "pg": "^8.11.3",                    // PostgreSQL ì—°ê²°
  "pg-pool": "^3.6.2",                // ì—°ê²° í’€ë§
  "@vercel/kv": "^2.0.0"              // Vercel KV Store
}
```

## ğŸ¤– A2A ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ

### ì—ì´ì „íŠ¸ ì •ì˜
```typescript
interface Agent {
  id: 'concierge' | 'needs_analyst' | 'data_analyst';
  name: string;
  role: string;
  capabilities: string[];
  systemPrompt: string;
}

const AGENTS = {
  concierge: {
    name: 'CarFin ìƒë‹´ ì´ê´„ ì—ì´ì „íŠ¸',
    role: 'ì§ˆë¬¸ ë¶„ì„ ë° í˜‘ì—… íë¦„ ê´€ë¦¬',
    capabilities: ['ì§ˆë¬¸íŒŒì‹±', 'í˜ë¥´ì†Œë‚˜ê°ì§€', 'ì‘ë‹µì¡°ìœ¨']
  },
  needs_analyst: {
    name: 'CarFin ë‹ˆì¦ˆ ë¶„ì„ ì—ì´ì „íŠ¸',
    role: 'ë¼ì´í”„ìŠ¤íƒ€ì¼ ë° ìˆ¨ì€ ë‹ˆì¦ˆ ë°œêµ´',
    capabilities: ['í˜ë¥´ì†Œë‚˜ë¶„ì„', 'ë¼ì´í”„ìŠ¤íƒ€ì¼ë§¤ì¹­', 'ìš°ì„ ìˆœìœ„ì„¤ì •']
  },
  data_analyst: {
    name: 'CarFin ì°¨ëŸ‰ ì¶”ì²œ ì—ì´ì „íŠ¸',
    role: 'ë§¤ë¬¼ ë¶„ì„ ë° TCO ê¸°ë°˜ ì¶”ì²œ',
    capabilities: ['ë§¤ë¬¼ê²€ìƒ‰', 'TCOê³„ì‚°', 'ë­í‚¹ìƒì„±']
  }
};
```

### í˜‘ì—… í”Œë¡œìš°
```typescript
async function a2aCollaboration(question: string, budget: Budget) {
  // 1ë‹¨ê³„: ìƒë‹´ ì´ê´„ ì—ì´ì „íŠ¸
  const initialAnalysis = await agents.concierge.analyze(question);
  const detectedPersona = await personalAnalyzer.detect(question, budget);

  // 2ë‹¨ê³„: ë‹ˆì¦ˆ ë¶„ì„ ì—ì´ì „íŠ¸ (ë°±ê·¸ë¼ìš´ë“œ)
  const needsAnalysis = agents.needs_analyst.analyzeNeeds({
    question,
    persona: detectedPersona,
    budget
  });

  // 3ë‹¨ê³„: ì°¨ëŸ‰ ì¶”ì²œ ì—ì´ì „íŠ¸ (ë°±ê·¸ë¼ìš´ë“œ)
  const dataAnalysis = agents.data_analyst.recommendVehicles({
    question,
    persona: detectedPersona,
    budget,
    needsInsights: await needsAnalysis
  });

  // ê²°ê³¼ í†µí•©
  return await agents.concierge.synthesize({
    needsAnalysis: await needsAnalysis,
    dataAnalysis: await dataAnalysis
  });
}
```

## ğŸ­ í˜ë¥´ì†Œë‚˜ ê°ì§€ ì‹œìŠ¤í…œ

### í•˜ì´ë¸Œë¦¬ë“œ ê°ì§€ ì•Œê³ ë¦¬ì¦˜
```typescript
interface PersonaDetectionResult {
  personaId: string;
  confidence: number; // 0-100
  method: 'keyword' | 'vector' | 'convergence';
  details: DetectionDetails;
}

class PersonaDetector {
  async detectPersona(question: string, budget: Budget) {
    const results: PersonaDetectionResult[] = [];

    // 1. í‚¤ì›Œë“œ ë§¤ì¹­ (ë¹ ë¥¸ ê°ì§€)
    const keywordResult = this.keywordMatching(question);
    if (keywordResult.confidence >= 80) {
      return keywordResult; // ì¦‰ì‹œ ë°˜í™˜
    }

    // 2. ë²¡í„° ìœ ì‚¬ë„ (ì˜ë¯¸ë¡ ì  ë¶„ì„)
    const vectorResult = await this.vectorSimilarity(question);
    results.push(vectorResult);

    // 3. ì»¨ë²„ì „ìŠ¤ ë³´ë„ˆìŠ¤ (ë‹¤ì¤‘ ë°©ë²• ì¼ì¹˜)
    if (this.isConvergent(keywordResult, vectorResult)) {
      return this.applyConvergenceBonus(results);
    }

    return this.selectBestResult(results);
  }
}
```

### í˜ë¥´ì†Œë‚˜ë³„ í‚¤ì›Œë“œ íŒ¨í„´
```typescript
const PERSONA_KEYWORDS = {
  ceo_executive: {
    primary: ['BMW', 'ê³¨í”„', 'í”„ë¦¬ë¯¸ì—„', 'ëŸ­ì…”ë¦¬'],
    secondary: ['ê³ ê¸‰', 'ë¸Œëœë“œ', 'í’ˆê²©', 'ì„ì›'],
    excludes: ['ì €ë ´', 'ì¤‘ê³ ', 'ì‹¤ìš©']
  },
  newlywed: {
    primary: ['ì‹ í˜¼', 'ê²°í˜¼', 'ì‹ ì°¨', 'ì•ˆì „'],
    secondary: ['ê²½ì œì ', 'ê°€ì¡±', 'ê³„íš', 'ë¯¸ë˜'],
    budget_preference: [2000, 3500] // ë§Œì› ë‹¨ìœ„
  },
  camping_lifestyle: {
    primary: ['ìº í•‘', 'SUV', 'ì ì¬', 'ì•„ì›ƒë„ì–´'],
    secondary: ['ì—¬í–‰', 'ìº í¼', 'ì§', 'ê³µê°„'],
    vehicle_types: ['SUV', 'í”½ì—…', 'ë°´']
  }
};
```

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### ì°¨ëŸ‰ ë§¤ë¬¼ í…Œì´ë¸”
```sql
CREATE TABLE vehicle_listings (
    vehicleid SERIAL PRIMARY KEY,
    manufacturer VARCHAR(50) NOT NULL,      -- ì œì¡°ì‚¬
    model VARCHAR(100) NOT NULL,            -- ëª¨ë¸ëª…
    modelyear INTEGER,                      -- ì—°ì‹
    price INTEGER,                          -- ê°€ê²© (ë§Œì›)
    distance INTEGER,                       -- ì£¼í–‰ê±°ë¦¬ (km)
    fueltype VARCHAR(20),                   -- ì—°ë£Œíƒ€ì…
    transmission VARCHAR(20),               -- ë³€ì†ê¸°
    displacement DECIMAL(3,1),              -- ë°°ê¸°ëŸ‰
    region VARCHAR(50),                     -- ì§€ì—­
    dealer_type VARCHAR(20),                -- ë”œëŸ¬íƒ€ì…
    accident_history VARCHAR(10),           -- ì‚¬ê³ ì´ë ¥
    maintenance_records TEXT,               -- ì •ë¹„ê¸°ë¡
    inspection_grade VARCHAR(5),            -- ì„±ëŠ¥ì ê²€
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ì¸ë±ìŠ¤ ìµœì í™”
CREATE INDEX idx_vehicle_price_range ON vehicle_listings(price);
CREATE INDEX idx_vehicle_manufacturer ON vehicle_listings(manufacturer);
CREATE INDEX idx_vehicle_model ON vehicle_listings(model);
CREATE INDEX idx_vehicle_year ON vehicle_listings(modelyear);
```

### ì„±ëŠ¥ ìµœì í™” ì¿¼ë¦¬
```sql
-- í˜ë¥´ì†Œë‚˜ë³„ ë§¤ë¬¼ ê²€ìƒ‰ (ì˜ˆ: CEO)
SELECT vehicleid, manufacturer, model, modelyear, price, distance
FROM vehicle_listings
WHERE price BETWEEN 2000 AND 8000
  AND manufacturer IN ('BMW', 'Mercedes-Benz', 'Audi', 'Lexus')
  AND modelyear >= 2018
  AND accident_history = 'None'
ORDER BY
  CASE
    WHEN manufacturer = 'BMW' THEN 1
    WHEN manufacturer = 'Mercedes-Benz' THEN 2
    ELSE 3
  END,
  price DESC
LIMIT 30;
```

## âš¡ ìºì‹œ ì‹œìŠ¤í…œ

### í•˜ì´ë¸Œë¦¬ë“œ ìºì‹œ ì•„í‚¤í…ì²˜
```typescript
class VercelCache {
  private memoryCache = new Map<string, CacheItem>();
  private fileCache = new FileCache('./cache');
  private kvStore = new KVStore(); // Vercel KV

  async get<T>(key: string): Promise<T | null> {
    // 1ìˆœìœ„: ë©”ëª¨ë¦¬ ìºì‹œ (ê°€ì¥ ë¹ ë¦„)
    const memoryResult = this.memoryCache.get(key);
    if (memoryResult && !this.isExpired(memoryResult)) {
      return memoryResult.data;
    }

    // 2ìˆœìœ„: íŒŒì¼ ìºì‹œ (ì¤‘ê°„ ì†ë„)
    const fileResult = await this.fileCache.get(key);
    if (fileResult) {
      this.memoryCache.set(key, fileResult); // ë©”ëª¨ë¦¬ì— ìŠ¹ê²©
      return fileResult.data;
    }

    // 3ìˆœìœ„: KV Store (ë„¤íŠ¸ì›Œí¬ í•„ìš”)
    const kvResult = await this.kvStore.get(key);
    if (kvResult) {
      this.memoryCache.set(key, kvResult);
      await this.fileCache.set(key, kvResult);
      return kvResult.data;
    }

    return null;
  }
}
```

### ìºì‹œ ì „ëµ
```typescript
const CACHE_STRATEGIES = {
  vehicleSearch: {
    ttl: 600, // 10ë¶„
    storage: 'file', // í° ë°ì´í„°ëŠ” íŒŒì¼ ìºì‹œ
    key: (budget: string, persona: string) => `search:${budget}_${persona}`
  },
  personaDetection: {
    ttl: 3600, // 1ì‹œê°„
    storage: 'memory', // ë¹ ë¥¸ ì ‘ê·¼ í•„ìš”
    key: (question: string) => `persona:${hashQuestion(question)}`
  },
  tcoCalculation: {
    ttl: 1800, // 30ë¶„
    storage: 'kv', // ì˜êµ¬ ë³´ê´€ í•„ìš”
    key: (vehicleId: string) => `tco:${vehicleId}`
  }
};
```

## ğŸ“Š ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°

### Server-Sent Events êµ¬í˜„
```typescript
// API Route: /api/chat
export async function POST(request: Request) {
  const encoder = new TextEncoder();

  const stream = new ReadableStream({
    start(controller) {
      const sendUpdate = (data: any) => {
        const formatted = `data: ${JSON.stringify(data)}\n\n`;
        controller.enqueue(encoder.encode(formatted));
      };

      // A2A í˜‘ì—… ì‹¤í–‰
      a2aCollaboration(question, budget, {
        onConciergeStart: () => sendUpdate({
          agent: 'concierge',
          status: 'started',
          message: 'ìƒë‹´ ì´ê´„ ì—ì´ì „íŠ¸ê°€ ì§ˆë¬¸ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...'
        }),
        onNeedsAnalysis: (result) => sendUpdate({
          agent: 'needs_analyst',
          status: 'analyzing',
          data: result
        }),
        onDataAnalysis: (result) => sendUpdate({
          agent: 'data_analyst',
          status: 'searching',
          data: result
        }),
        onComplete: (finalResult) => {
          sendUpdate({ status: 'completed', data: finalResult });
          controller.close();
        }
      });
    }
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/plain; charset=utf-8',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive'
    }
  });
}
```

## ğŸ”§ ë°°í¬ & ìš´ì˜

### Vercel ë°°í¬ ì„¤ì •
```json
// vercel.json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "nextjs",
  "functions": {
    "app/api/**/*.ts": {
      "maxDuration": 60
    }
  },
  "env": {
    "DATABASE_URL": "@database_url",
    "GEMINI_API_KEY": "@gemini_api_key",
    "KV_URL": "@kv_url"
  }
}
```

### í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬
```bash
# .env.local (ê°œë°œí™˜ê²½)
DATABASE_URL="postgresql://..."
GEMINI_API_KEY="AIza..."
KV_URL="redis://..."
NEXT_PUBLIC_APP_URL="http://localhost:3000"

# Vercel í™˜ê²½ë³€ìˆ˜ (í”„ë¡œë•ì…˜)
DATABASE_URL=@database_url
GEMINI_API_KEY=@gemini_api_key
KV_URL=@kv_url
NEXT_PUBLIC_APP_URL="https://carfin-clean-...vercel.app"
```

## ğŸ“ˆ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### í•µì‹¬ ì§€í‘œ
```typescript
interface PerformanceMetrics {
  responseTime: {
    personaDetection: number;    // ~1ì´ˆ
    vehicleSearch: number;       // ~3ì´ˆ
    a2aCollaboration: number;    // ~30-45ì´ˆ
    totalFlow: number;           // ~50ì´ˆ
  };

  cacheEfficiency: {
    hitRate: number;             // ëª©í‘œ: 85%+
    speedImprovement: number;    // 18ë°° í–¥ìƒ
  };

  userSatisfaction: {
    completionRate: number;      // ëª©í‘œ: 90%+
    reAnalysisRate: number;      // ëª©í‘œ: <15%
  };
}
```

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-09-30
**ê¸°ìˆ  ìŠ¤íƒ í™•ì •**: Next.js 15 + React 19 + Gemini 2.5 Flash + PostgreSQL
**ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ**: ìƒë‹´ ì´ê´„ + ë‹ˆì¦ˆ ë¶„ì„ + ì°¨ëŸ‰ ì¶”ì²œ (3-Agent A2A)